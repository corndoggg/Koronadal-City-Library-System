# Koronadal City Library System - Updated Requirements (2025-09-25)

## 1. Overview
The Koronadal City Library System (KCLS) manages library resources (books, documents), user accounts, borrowing, automated reminders, digital access, auditing, and analytics. This specification reflects the current implemented behavior plus clearly marked gaps and deferred items.

## 2. Terminology
- Physical Book: Inventory managed via `Book_Inventory` (copy availability decremented immediately on borrow request).
- Physical Document: A document with an associated `DocumentStorageID` (inventory updated only after approval).
- Digital Document: A document without a `DocumentStorageID`; accessed via PDF viewer, auto-returned at/after due date.
- Borrow Transaction: A grouped borrow request containing homogeneous items (system splits mixed submissions into separate transactions by item type category: Books vs Documents).
- Return Transaction: Record of returning items; for digital-only, auto-generated by system (status set to Returned and displayed as Expired in UI).
- Approval Status: `Pending | Approved | Rejected`.
- Retrieval Status: `Pending | Retrieved` (only relevant for physical items after approval and before return).
- Return Status: `Not Returned | Returned` (digital Returned rendered as Expired to user).
- Audit Event: Logged user/system action with action code, target type, optional details.

## 3. Functional Requirements
### 3.1 User & Authentication
FR-001 Users can register (borrowers) and require admin approval before access to borrowing features.
FR-002 Staff (Librarian, Admin) accounts are created/managed internally (scope future admin UI).
FR-003 Passwords are stored hashed using PBKDF2 (Werkzeug). Legacy plaintext entries are transparently rehashed on next successful login.
FR-004 Users can authenticate with username + password; system validates hashed credentials.
FR-005 (Deferred) Account lockout after N failed attempts (policy not implemented). See NFR-Security Notes.

### 3.2 Roles & Access Control
FR-010 Borrower: Browse/search, view documents/books, request borrows, view notifications, view own borrow history.
FR-011 Librarian: Manage book borrow approvals, retrieval marking, returns for book-only transactions, view analytics, audit logs (read-only), notifications.
FR-012 Admin: Manage document borrow approvals (physical & digital), document uploads/updates, returns for document transactions, analytics, audit logs.
FR-013 (Future) Fine calculation & payment workflow (not defined here; only analytic placeholder fields exist if any).

### 3.3 Resource Management
FR-020 Books have metadata (title, author, etc.) and distinct inventory copies in `Book_Inventory` with availability flag.
FR-021 Documents have metadata and may have multiple physical storage copies (`DocumentStorageID`) OR be digital-only (no storage record).
FR-022 Digital document content stored as PDF; system can assemble PDF from uploaded images (multi-image → single PDF) before final save.
FR-023 Document metadata analysis (AI/auto extraction) is triggered after closing the PDF preview in the document form (edit/create).

### 3.4 Borrowing Workflow
FR-030 A borrow submission containing mixed item types is split into: one Book transaction and one Document transaction (if both types present).
FR-031 Book transaction: Availability of each `Book_Inventory` copy set to unavailable immediately on submission (optimistic reservation).
FR-032 Document transaction (physical): Availability of `Document_Inventory` (or equivalent) updated only upon approval; rejection releases nothing (since not reserved yet).
FR-033 Digital document borrow: No inventory toggle; due date recorded in `ReturnTransactions` upon approval if provided.
FR-034 Approval operations set `ApprovalStatus` and trigger notifications (Approved or Rejected).
FR-035 Physical items may be marked as Retrieved (`RetrievalStatus='Retrieved'`) by staff to indicate user pickup.
FR-036 Returns: Staff record return transactions including condition updates for physical items; availability restored.
FR-037 Digital-only Approved borrows are auto-marked Returned (rendered as Expired) on or after due date by background service.
FR-038 Borrow item record schema includes: ItemType (Book|Document), ItemID (BookID or Document_ID), for documents optionally `DocumentStorageID`.
FR-039 Return status summarization: A borrow is `Returned` only if all items are processed via ReturnTransactions (or auto-return for digital).
FR-040 Maximum due date endpoint returns MAX(ReturnDate) for a BorrowID (used for UI status derivation).
FR-041 Overdue reminder notifications sent once per day per borrow after due date until Returned (implementation pending background runner—helper present).

### 3.5 Digital Access
FR-050 Borrowers can view digital PDF only while status is Active (Approved & not auto-returned/expired).
FR-051 After digital auto-return (Expired), PDF View button is hidden/disabled.
FR-052 Document PDF preview available in form modal prior to final save; closing preview triggers metadata analysis.

### 3.6 Notifications
FR-060 System sends notifications for: submission (to appropriate staff), approval, rejection, ready for pickup (bundled with approval), retrieval, return recorded, overdue reminder, account registration submitted, account approved/rejected.
FR-061 Duplicate overdue reminders for same borrow/date are suppressed.
FR-062 Notifications store type code, title, message, sender user id (may be borrower initiating), related entity reference.
FR-063 Borrowers and staff can view notifications; recipient mapping via `notification_recipients`.

### 3.7 Audit Logging
FR-070 Every significant action (login attempt/success/failure, document view, document upload/update, borrow submit/approve/reject/retrieve/return, overdue reminder emission) creates an AuditLog row.
FR-071 AuditLog fields: AuditID, UserID (nullable), ActionCode, TargetTypeCode, TargetID (nullable), Details (JSON or text), IPAddress (nullable), UserAgent (nullable), CreatedAt (UTC).
FR-072 ActionTypes and TargetTypes reference tables manage valid codes (insert-ignore seeding allowed at runtime).
FR-073 Frontend Audit Logs page supports filtering: actionCode, targetType, userId, targetId, date range; client-side text search across details.
FR-074 Audit logging utility on frontend standardizes payload shape.

### 3.8 Dashboard & Analytics
FR-080 Dashboard shows: Borrow status distribution, Borrow mix (Books vs Documents vs Digital), Availability breakdown, Monthly borrow trend, Top borrowers, Recent borrow activity with borrower names and item titles.
FR-081 Digital Returned -> surfaced as Expired for clarity distinct from physical returned workflows.
FR-082 Aggregations exclude soft-deleted resources (if deletion introduced later; currently not implemented).

### 3.9 Image-to-PDF & Metadata
FR-090 Users (Admin) can upload multiple images to generate a single PDF inside `DocumentFormModal`.
FR-091 Generated PDF is previewed; only after closing preview is AI/analysis invoked (if configured) to populate metadata suggestion fields.
FR-092 Editing a document supports replacing original files via same workflow.

### 3.10 Search & Listing
FR-100 Borrow listings filter by role (librarian sees Book-only, admin sees Document-inclusive) while users see their own transactions.
FR-101 Audit listing server-side pagination/filtering (if implemented; current spec assumes backend supports parameters used by UI).

### 3.11 System Settings & Backup (Placeholder)
FR-110 System settings loaded from `config/system.json`; (Detailed CRUD endpoints TBD).
FR-111 Backup/restore mechanisms (if any) not yet implemented; requirement deferred.

### 3.12 Exports (Deferred)
FR-120 Export of reports or audit logs not implemented; reserved for future scope.

## 4. Non-Functional Requirements
### 4.1 Security
NFR-SEC-01 Password hashing must use PBKDF2 with strong iteration count (`pbkdf2:sha256:600000`).
NFR-SEC-02 Legacy plaintext passwords must be replaced (rehash) upon successful login.
NFR-SEC-03 (Planned) Account lockout after configurable consecutive failures (e.g., 5) with timed release (NOT IMPLEMENTED).
NFR-SEC-04 Audit trail must not be editable via standard user interfaces.
NFR-SEC-05 Digital documents accessible only by authenticated, authorized users associated with an active borrow.

### 4.2 Reliability & Background Services
NFR-R-01 Auto-return service runs continuously (interval ~60s) marking digital borrows whose due date has passed as Returned.
NFR-R-02 Overdue reminder service should run at least daily; CURRENT GAP: runner script/file missing (`overdue_reminder.py`).
NFR-R-03 Background service failures must not crash main Flask app (exceptions isolated and logged to stdout / future logging sink).

### 4.3 Performance
NFR-P-01 Borrow listing queries should aggregate return status with single joined query (avoid N+1 for return date lookups).
NFR-P-02 Auto-return scan must limit scope to candidate transactions via indexed status columns.
NFR-P-03 Dashboard aggregations should rely on indexed columns (BorrowTransactions.ApprovalStatus, ReturnStatus, CreatedAt).

### 4.4 Maintainability
NFR-M-01 Action codes and target type codes centralized; adding a new action requires only seeding + frontend constant usage.
NFR-M-02 Digital vs physical logic encapsulated by presence of `DocumentStorageID` only (no DocType branching). Simplicity maintained.
NFR-M-03 Splitting borrow logic resides in one endpoint (`add_borrow_transaction`) to ensure consistency.

### 4.5 Observability
NFR-O-01 All critical state transitions produce audit events.
NFR-O-02 Overdue reminder and auto-return actions produce both notification and audit entries (overdue reminder audit currently implemented, verify auto-return audit if desired—GAP: auto-return currently not calling `log_event`).

### 4.6 UX
NFR-UX-01 PDF View button hidden after digital expiration to reduce confusion.
NFR-UX-02 Dashboard metrics update on page load (real-time refresh interval optional future enhancement).

## 5. Data Model Summary (Selected)
- BorrowTransactions(BorrowID, BorrowerID, ApprovalStatus, RetrievalStatus, ReturnStatus, CreatedAt,...)
- BorrowedItems(BorrowedItemID, BorrowID, ItemType, BookID?, Document_ID?, DocumentStorageID?, ...)
- ReturnTransactions(ReturnID, BorrowID, ReturnDate, CreatedAt,...)
- ReturnedItems(ReturnedItemID, ReturnID, BorrowedItemID, ConditionBefore, ConditionAfter)
- AuditLog(AuditID, UserID, ActionCode, TargetTypeCode, TargetID, Details, IPAddress, UserAgent, CreatedAt)
- ActionTypes(ActionCode, Description)
- TargetTypes(TargetTypeCode, Description)
- notifications / notification_recipients / notification_types
- Users / UserDetails / Borrowers / Staff / Book_Inventory / Document_Inventory

## 6. Status Mapping (UI Consistency)
- Digital Active: ApprovalStatus=Approved & ReturnStatus != Returned & all items digital.
- Digital Expired: ApprovalStatus=Approved & ReturnStatus=Returned & all items digital.
- Physical In-Progress: Approved & Retrieved pending.
- Physical Retrieved: Approved & Retrieved.
- Returned: Physical items returned OR digital auto-returned (internal) — UI label differs (Expired vs Returned) based on digital-only flag.

## 7. Gaps & Recommendations
GAP-01 Overdue reminder runner missing (implement scheduler similar to auto_return service calling `notify_overdue`).
GAP-02 Auto-return does not currently create an explicit audit log entry (add `log_event('BORROW_AUTO_RETURN', ...)`).
GAP-03 Account lockout security control not implemented; add table or counters + time window.
GAP-04 Export/report endpoints undefined—clarify scope before implementation.
GAP-05 System settings & backup endpoints unspecified—draft mini spec if needed.

## 8. Future Enhancements (Non-Binding)
- Two-factor authentication for staff accounts.
- Fine calculation engine & settlement log.
- Real-time websocket push for notifications/audit stream.
- Report exports (CSV/PDF) for borrow statistics & audit logs.
- Soft delete & archival policies (GDPR-style data minimization).

## 9. Acceptance Checklist
[ ] Mixed borrow submission splits correctly.
[ ] Digital borrow auto-returns on due date.
[ ] Physical approval toggles inventory only upon approval.
[ ] Rejection restores or leaves inventory consistent (books already reserved then freed).
[ ] PDF view disabled post-expiration.
[ ] Image→PDF workflow triggers metadata analysis only after preview close.
[ ] Notifications fire for each lifecycle event (spot test borrow + return + overdue).
[ ] Audit logs present for key actions (login, borrow lifecycle, doc view/upload, overdue reminder).
[ ] Passwords hashed after first successful login of legacy user.
[ ] Dashboard metrics reflect test data accurately.

## 10. Change Log
2025-09-25: Consolidated and updated requirements to reflect refactored borrowing model (Document_ID logic), auditing, automation services, digital access gating, and dashboard analytics; identified operational gaps.

---
End of specification.
